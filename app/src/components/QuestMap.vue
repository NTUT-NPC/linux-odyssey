<template>
  <div class="relative bg-black w-full h-full flex">
    <div
      class="text-slate-500 relative flex flex-col blur-[2px] w-1/2 h-full flex-wrap"
    >
      <h1 class="relative flex w-fit" style="left: 38%; height: 3%">
        01111000 00100000 01001111 01100100 01111001 01110011
      </h1>
      <h1 class="relative flex w-fit" style="left: 26%; height: 3%">
        01110011 01100101 01111001 00100001 01010111 01100101
      </h1>
      <h1 class="relative flex w-fit" style="left: 20%; height: 3%">
        01101100 01100011 01101111 01101101 01100101 00100000
      </h1>
      <h1 class="relative flex w-fit" style="left: 15%; height: 3%">
        01110100 01101111 00100000 01001100 01101001 01101110
      </h1>
      <h1 class="relative flex w-fit" style="left: 5%; height: 3%">
        01101101 01100101 00100000 01110100 01101111 01101111
        <h1 class="relative flex w-fit" style="left: 13%; height: 3%">
          01101110 01110101 01111000 00100000 01001111 01100100
        </h1>
        <h1 class="relative flex w-fit" style="left: 5%; height: 3%">
          01010111 01100101 01101100 01100011 01111000
        </h1>
        <h1 class="relative flex w-fit" style="left: 3%; height: 3%">
          01101111 01101101 01100101 00100000 01110100
        </h1>
        <h1 class="relative flex w-fit" style="left: 13%; height: 3%">
          00100000 01001100 01101001 01101110 01110101
        </h1>
        <h1 class="relative flex w-fit" style="left: 16%; height: 3%">
          00100000 01001111 01100100 01111001 01110011
        </h1>
        <h1 class="relative flex w-fit" style="left: 17%; height: 3%">
          01110011 01100101 01111001 00100001 01010111
        </h1>
        <h1 class="relative flex w-fit" style="left: 12%; height: 3%">
          01100101 01101100 01100011 01101111 01101101
        </h1>
        <h1 class="relative flex w-fit" style="left: 8%; height: 3%">
          01100101 00100000 01110100 01101111 01010111
        </h1>
        <h1 class="relative flex w-fit" style="left: 8%; height: 3%">
          00100000 01001100 01101001 01101110 01110101
        </h1>
        <h1 class="relative flex w-fit" style="left: 9%; height: 3%">
          01111000 00100000 01001111 01100100 01111001
        </h1>
        <h1 class="relative flex w-fit" style="left: 6%; height: 3%">
          01110011 01110011 01100101 01101100 01101100 01101001
        </h1>
        <h1 class="relative flex w-fit" style="left: 5%; height: 3%">
          01111001 00100001 01010111 01100011 01100101 01101001
        </h1>
        <h1 class="relative flex w-fit" style="left: 9%; height: 3%">
          01100101 01101100 01110101 01111000 01001100
        </h1>
        <h1 class="relative flex w-fit" style="left: 7%; height: 3%">
          00100000 01001111 01100100 01111001 01110011 01110011
        </h1>
        <h1 class="relative flex w-fit" style="left: 3%; height: 3%">
          01100101 01111001 00100001 01010111 01100101
        </h1>
        <h1 class="relative flex w-fit" style="left: 6%; height: 3%">
          01101111 01101101 01010111 01100101 01101100 01100011
        </h1>
        <h1 class="relative flex w-fit" style="left: 5%; height: 3%">
          01101101 01100101 00100000 01110100 01101111 00100000
        </h1>
        <h1 class="relative flex w-fit" style="left: 3%; height: 3%">
          01101110 01110101 01111000 00100000 01001111 01100100
        </h1>
        <h1 class="relative flex w-fit" style="left: 6%; height: 3%">
          01100011 01101111 01101101 01111001 01110011
        </h1>
        <h1 class="relative flex w-fit" style="left: 9%; height: 3%">
          01100101 00100000 01110100 01001100
        </h1>
        <h1 class="relative flex w-fit" style="left: 7%; height: 3%">
          01101111 00100000 01001100 01101111 01101111
        </h1>
        <h1 class="relative flex w-fit" style="left: 5%; height: 3%">
          01101001 01101110 011101010 1111001 01110011
        </h1>
        <h1 class="relative flex w-fit" style="left: 6%; height: 3%">
          01111000 00100000 01001111 00100000
        </h1>
      </h1>
      <h1 class="relative flex w-fit" style="left: 4%; height: 3%">
        01100100 01111001 01110011 01110011
      </h1>
      <h1 class="relative flex w-fit" style="left: 3%; height: 3%">
        01100101 01111001 00100001
      </h1>
      <h1 class="relative flex w-fit" style="left: 5%; height: 3%">
        01100101 01101100 01100011 01101111
      </h1>
      <h1 class="relative flex w-fit" style="left: 2%; height: 3%">
        01101101 01100101 00100000 01110100
      </h1>
      <h1 class="relative flex w-fit" style="left: 3%; height: 3%">
        00100000 01001100 01101001 01101110 01110101
      </h1>
    </div>
    <div
      class="text-slate-500 relative flex flex-col blur-[2px] w-1/2 h-full flex-wrap"
    >
      <h1 class="relative flex w-fit" style="left: 7%; height: 3%">
        01010111 01100101 01101100 01100011 01001100 01101001 00100000
      </h1>
      <h1 class="relative flex w-fit" style="left: 14%; height: 3%">
        01101111 01101101 01100101 00100000 01110100 01101111 01100100
      </h1>
      <h1 class="relative flex w-fit" style="left: 18%; height: 3%">
        00100000 01001100 01101001 01101110 01110101 01111000
      </h1>
      <h1 class="relative flex w-fit" style="left: 19%; height: 3%">
        00100000 01001111 01100100 01111001 01110011 01101111
      </h1>
      <h1 class="relative flex w-fit" style="left: 25%; height: 3%">
        01110011 01100101 01111001 00100001 01010111 01100100
      </h1>
      <h1 class="relative flex w-fit" style="left: 24%; height: 3%">
        01100101 01101100 01100011 01101111 01101101 01110011
      </h1>
      <h1 class="relative flex w-fit" style="left: 23%; height: 3%">
        01100101 00100000 01110100 01101111 00100000 01111001
      </h1>
      <h1 class="relative flex w-fit" style="left: 23%; height: 3%">
        00100000 01001100 01101001 01101110 01110101 01111001 01110011
      </h1>
      <h1 class="relative flex w-fit" style="left: 27%; height: 3%">
        01111000 00100000 01001111 01100100 01111001 01100100
      </h1>
      <h1 class="relative flex w-fit" style="left: 29%; height: 3%">
        01110011 01110011 01100101 01111001 01110011
      </h1>
      <h1 class="relative flex w-fit" style="left: 35%; height: 3%">
        01111001 00100001 01010111 01101110 01110011
      </h1>
      <h1 class="relative flex w-fit" style="left: 30%; height: 3%">
        01100101 01101100 01100011 01100101 01101100
      </h1>
      <h1 class="relative flex w-fit" style="left: 20%; height: 3%">
        01100011 01101111 01101101 01100100 01111001 01110011
      </h1>
      <h1 class="relative flex w-fit" style="left: 23%; height: 3%">
        01100101 00100000 01110100 01101111 01100101 01101001
      </h1>
      <h1 class="relative flex w-fit" style="left: 27%; height: 3%">
        01101111 00100000 01001100 01100101 01101100 01101111
      </h1>
      <h1 class="relative flex w-fit" style="left: 28%; height: 3%">
        01101001 01101110 01110101 01001100 01101001 01001111
      </h1>
      <h1 class="relative flex w-fit" style="left: 35%; height: 3%">
        01111000 00100000 01001111 00100000 01100011
      </h1>
      <h1 class="relative flex w-fit" style="left: 32%; height: 3%">
        01100100 01111001 01110011 01110011 01010111 01100101
      </h1>
      <h1 class="relative flex w-fit" style="left: 29%; height: 3%">
        01100101 01111001 00100001 01010111 01010111 01101100
      </h1>
      <h1 class="relative flex w-fit" style="left: 43%; height: 3%">
        01100101 01101100 01100011 01101111 01001111
      </h1>
      <h1 class="relative flex w-fit" style="left: 46%; height: 3%">
        01101101 01100101 00100000 01110100
      </h1>
      <h1 class="relative flex w-fit" style="left: 43%; height: 3%">
        00100000 01001100 01101001 01101110 01110101
      </h1>
      <h1 class="relative flex w-fit" style="left: 45%; height: 3%">
        01111000 00100000 01001111 01100100 01111001
      </h1>
      <h1 class="relative flex w-fit" style="left: 52%; height: 3%">
        01110011 01100101 01111001 00100001
      </h1>
      <h1 class="relative flex w-fit" style="left: 48%; height: 3%">
        01101100 01100011 01101111 01101101
      </h1>
      <h1 class="relative flex w-fit" style="left: 53%; height: 3%">
        01110100 01101111 00100000 01001100
      </h1>
      <h1 class="relative flex w-fit" style="left: 52%; height: 3%">
        01110101 01111000 00100000 01001111
      </h1>
      <h1 class="relative flex w-fit" style="left: 59%; height: 3%">
        01100101 01111001 00100001
      </h1>
      <h1 class="relative flex w-fit" style="left: 50%; height: 3%">
        01101111 01101101 01010111 01100101
      </h1>
      <h1 class="relative flex w-fit" style="left: 51%; height: 3%">
        01101101 01100101 00100000 01110100
      </h1>
      <h1 class="relative flex w-fit" style="left: 50%; height: 3%">
        01101110 01110101 01111000 00100000
      </h1>
      <h1 class="relative flex w-fit" style="left: 52%; height: 3%">
        01101101 01100101 00100000 01110100
      </h1>
      <h1 class="relative flex w-fit" style="left: 43%; height: 3%">
        01101110 01110101 01111000 00100000 01101111
      </h1>
    </div>
    <h1
      class="text-text-primary text-xl p-2.5 absolute w-fit z-2 font-mono font-bold flex flax-wrap"
    >
      Get through your linux journey!
    </h1>
    <div class="flex flex-wrap absolute w-full h-full z-1">
      <div ref="chartContainer" class="w-full h-full flex flex-wrap"></div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useToast } from 'vue-toastification'
import { use, init } from 'echarts/core'
import { GraphChart } from 'echarts/charts'
import { SVGRenderer } from 'echarts/renderers'
import { TitleComponent, TooltipComponent } from 'echarts/components'
import { DAG } from '@linux-odyssey/utils'
import api from '../utils/api'
import { NodeImage } from '../img/svg.js'

const marginX = 100
const marginY = 65
const chartContainer = ref(null)
let chartInstance = null

use([GraphChart, SVGRenderer, TitleComponent, TooltipComponent])

async function getQuests() {
  try {
    const res = await api.get('/quests')
    return res.data
  } catch (err) {
    console.error(err)
    throw err
  }
}

async function getProgress() {
  try {
    const res = await api.get('/users/me')
    console.log(res.data.progress)
    return res.data.progress
  } catch (err) {
    console.error(err)
    throw err
  }
}

const genOption = (nodes, edges) => ({
  render: 'svg',
  tooltip: {},
  animationDurationUpdate: 1500,
  animationEasingUpdate: 'quinticInOut',
  series: [
    {
      type: 'graph',
      layout: 'none',
      symbol: () => {
        return NodeImage
      },
      symbolSize: [200, 100],
      roam: true,
      label: {
        show: true,
        fontSize: 22,
      },
      edgeSymbol: ['pin', 'arrow'],
      edgeSymbolSize: [2, 15],
      edgeLabel: {
        fontSize: 25,
      },
      data: nodes,
      // links: [],
      links: edges,
      lineStyle: {
        opacity: 4,
        width: 3,
        curveness: 0.08,
      },
      itemStyle: {
        color: (params) => {
          const {
            data: { completed },
          } = params
          switch (completed) {
            case true:
              return '#ADADB5'
            default:
              return '#454552'
          }
        },
      },
    },
  ],
})

function getOption(quests, progress) {
  const dag = new DAG(quests)
  console.log(progress)

  const nodes = dag.getNodes().map((node) => ({
    id: node._id,
    name: node.title,
    x: marginX * node.index - (marginX * dag.getLayer(node._id)) / 2,
    y: marginY * node.layer,
    completed: progress[node._id]?.completed || false,
    unlocked: node.requirements.every((req) => progress[req]?.completed),
  }))

  console.log(nodes)

  const edges = dag.getEdgesArray().map((edge) => ({
    source: edge[0],
    target: edge[1],
  }))
  return genOption(nodes, edges)
}

const router = useRouter()
const toast = useToast()

function initChart(option) {
  console.log('initChart', chartContainer.value)
  chartInstance = init(chartContainer.value)
  chartInstance.setOption(option)
  chartInstance.on('click', (params) => {
    const {
      data: { id, unlocked },
    } = params

    if (unlocked) {
      router.push({ name: 'game', params: { questId: id } })
    } else {
      toast.warning('You have not completed the previous quest yet!')
    }
  })
}

onMounted(async () => {
  const quests = await getQuests()
  const progress = await getProgress()
  const option = getOption(quests, progress)
  initChart(option)
})
</script>
